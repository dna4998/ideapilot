<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
  <meta name="theme-color" content="#8b5cf6"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <meta name="apple-mobile-web-app-title" content="IdeaPilot"/>
  <meta name="description" content="AI-powered idea research and validation assistant"/>
  <title>IdeaPilot</title>

  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json"/>

  <!-- iOS Icons -->
  <link rel="apple-touch-icon" href="/icons/icon-180x180.png"/>
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/icon-152x152.png"/>
  <link rel="apple-touch-icon" sizes="167x167" href="/icons/icon-167x167.png"/>
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/icon-180x180.png"/>

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-32x32.png"/>
  <link rel="icon" type="image/png" sizes="64x64" href="/icons/icon-64x64.png"/>

  <!-- Splash screens for iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes"/>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,400&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet"/>

  <!-- React from CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>

  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body, #root { width: 100%; height: 100%; overflow: hidden; }
    body {
      background: #0a0a12;
      font-family: 'DM Sans', 'Segoe UI', system-ui, sans-serif;
      color: #e8e4f0;
      -webkit-font-smoothing: antialiased;
      -webkit-tap-highlight-color: transparent;
      /* iOS safe area */
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }
    *::-webkit-scrollbar { width: 6px; }
    *::-webkit-scrollbar-track { background: transparent; }
    *::-webkit-scrollbar-thumb { background: rgba(139,92,246,0.2); border-radius: 3px; }
    *::-webkit-scrollbar-thumb:hover { background: rgba(139,92,246,0.4); }
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.4; transform: scale(0.85); }
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @media (max-width: 768px) {
      .sidebar-default { width: 0 !important; min-width: 0 !important; }
    }
    textarea { font-family: inherit; }
    input { font-family: inherit; }
    button { font-family: inherit; }
    /* iOS standalone keyboard fix */
    @supports (-webkit-touch-callout: none) {
      .input-area { padding-bottom: calc(12px + env(safe-area-inset-bottom)); }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script>
    // Register service worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').catch(() => {});
      });
    }
  </script>

  <script>
    const { useState, useRef, useEffect, useCallback, createElement: h, Fragment } = React;

    const ANTHROPIC_MODEL = "claude-sonnet-4-20250514";

    // ── Storage ──
    const STORAGE_KEY = "ideapilot-ideas";
    const loadIdeas = () => { try { const r = localStorage.getItem(STORAGE_KEY); return r ? JSON.parse(r) : []; } catch { return []; } };
    const saveIdeas = (ideas) => { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(ideas)); } catch {} };

    // ── SVG helper ──
    const svg = (props, ...children) => h('svg', props, ...children);
    const line = (props) => h('line', props);
    const circle = (props) => h('circle', props);
    const path = (props) => h('path', props);
    const rect = (props) => h('rect', props);
    const polyline = (props) => h('polyline', props);
    const polygon = (props) => h('polygon', props);
    const stop = (props) => h('stop', props);
    const defs = (props, ...ch) => h('defs', props, ...ch);
    const linearGradient = (props, ...ch) => h('linearGradient', props, ...ch);
    const radialGradient = (props, ...ch) => h('radialGradient', props, ...ch);
    const g = (props, ...ch) => h('g', props, ...ch);

    // ── Icons ──
    const Icons = {
      Mic: (p) => svg({width:p.size||20,height:p.size||20,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"}, path({d:"M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"}), path({d:"M19 10v2a7 7 0 0 1-14 0v-2"}), line({x1:12,x2:12,y1:19,y2:22})),
      Send: (p) => svg({width:p.size||20,height:p.size||20,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"}, path({d:"m22 2-7 20-4-9-9-4Z"}), path({d:"M22 2 11 13"})),
      Plus: (p) => svg({width:p.size||20,height:p.size||20,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"}, path({d:"M5 12h14"}), path({d:"M12 5v14"})),
      Trash: (p) => svg({width:p.size||18,height:p.size||18,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"}, path({d:"M3 6h18"}), path({d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"}), path({d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"})),
      File: (p) => svg({width:p.size||20,height:p.size||20,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"}, path({d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"}), path({d:"M14 2v4a2 2 0 0 0 2 2h4"})),
      Image: (p) => svg({width:p.size||20,height:p.size||20,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"}, rect({width:18,height:18,x:3,y:3,rx:2,ry:2}), circle({cx:9,cy:9,r:2}), path({d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"})),
      Share: (p) => svg({width:p.size||18,height:p.size||18,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"}, path({d:"M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"}), polyline({points:"16 6 12 2 8 6"}), line({x1:12,x2:12,y1:2,y2:15})),
      Mail: (p) => svg({width:p.size||18,height:p.size||18,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"}, rect({width:20,height:16,x:2,y:4,rx:2}), path({d:"m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"})),
      Copy: (p) => svg({width:p.size||18,height:p.size||18,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"}, rect({width:14,height:14,x:8,y:8,rx:2,ry:2}), path({d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"})),
      Search: (p) => svg({width:p.size||18,height:p.size||18,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"}, circle({cx:11,cy:11,r:8}), path({d:"m21 21-4.3-4.3"})),
      Star: (p) => svg({width:p.size||16,height:p.size||16,viewBox:"0 0 24 24",fill:p.fill||"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"}, polygon({points:"12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"})),
      Menu: (p) => svg({width:p.size||22,height:p.size||22,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"}, line({x1:4,x2:20,y1:12,y2:12}), line({x1:4,x2:20,y1:6,y2:6}), line({x1:4,x2:20,y1:18,y2:18})),
      X: (p) => svg({width:p.size||20,height:p.size||20,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"}, path({d:"M18 6 6 18"}), path({d:"m6 6 12 12"})),
      ChevRight: (p) => svg({width:p.size||16,height:p.size||16,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"}, path({d:"m9 18 6-6-6-6"})),
      Stop: (p) => svg({width:p.size||20,height:p.size||20,viewBox:"0 0 24 24",fill:"currentColor"}, rect({x:6,y:6,width:12,height:12,rx:2})),
    };

    // ── Neural Spark Logo ──
    function NeuralSparkLogo(props) {
      const size = props.size || 40;
      const connections = [[60,60,28,28],[60,60,92,28],[60,60,20,70],[60,60,100,70],[60,60,35,100],[60,60,85,100]];
      const secondary = [[28,28,20,70],[92,28,100,70],[20,70,35,100],[100,70,85,100]];
      const nodes = [[28,28,"#8b5cf6"],[92,28,"#ec4899"],[20,70,"#8b5cf6"],[100,70,"#ec4899"],[35,100,"#a78bfa"],[85,100,"#a78bfa"]];

      return svg({width:size,height:size,viewBox:"0 0 120 120",fill:"none"},
        defs(null,
          linearGradient({id:"nsp-grad",x1:0,y1:0,x2:1,y2:1}, stop({offset:"0%",stopColor:"#8b5cf6"}), stop({offset:"100%",stopColor:"#ec4899"})),
          radialGradient({id:"nsp-glow",cx:"50%",cy:"50%"}, stop({offset:"0%",stopColor:"#c4b5fd",stopOpacity:0.35}), stop({offset:"100%",stopColor:"#8b5cf6",stopOpacity:0})),
          linearGradient({id:"nsp-line",x1:0,y1:0,x2:1,y2:1}, stop({offset:"0%",stopColor:"#8b5cf6",stopOpacity:0.5}), stop({offset:"100%",stopColor:"#ec4899",stopOpacity:0.3}))
        ),
        circle({cx:60,cy:60,r:35,fill:"url(#nsp-glow)"}),
        ...connections.map((c,i) => line({key:"c"+i,x1:c[0],y1:c[1],x2:c[2],y2:c[3],stroke:"url(#nsp-line)",strokeWidth:1.5})),
        ...secondary.map((c,i) => line({key:"s"+i,x1:c[0],y1:c[1],x2:c[2],y2:c[3],stroke:"#8b5cf6",strokeWidth:1,opacity:0.2})),
        ...nodes.map((n,i) => g({key:"n"+i}, circle({cx:n[0],cy:n[1],r:7,fill:"#0d0d1a",stroke:"url(#nsp-grad)",strokeWidth:1.5}), circle({cx:n[0],cy:n[1],r:2.2,fill:n[2],opacity:0.6}))),
        circle({cx:60,cy:60,r:18,fill:"url(#nsp-grad)"}),
        path({d:"M60 47 L63.5 57 L58 55 L62 67 L56 61 L60 63 Z",fill:"#ffffff",opacity:0.92}),
        path({d:"M60 73 L56.5 63 L62 65 L58 53 L64 59 L60 57 Z",fill:"#ffffff",opacity:0.5})
      );
    }

    // ── Markdown renderer ──
    function renderMarkdown(text) {
      if (!text) return "";
      return text
        .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
        .replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>")
        .replace(/\*(.+?)\*/g,"<em>$1</em>")
        .replace(/`(.+?)`/g,'<code style="background:#1a1a2e;padding:2px 6px;border-radius:4px;font-size:0.85em">$1</code>')
        .replace(/^### (.+)$/gm,'<h3 style="font-size:1.05em;font-weight:700;margin:16px 0 6px;color:#c8b4ff">$1</h3>')
        .replace(/^## (.+)$/gm,'<h2 style="font-size:1.15em;font-weight:700;margin:18px 0 8px;color:#c8b4ff">$1</h2>')
        .replace(/^# (.+)$/gm,'<h1 style="font-size:1.3em;font-weight:800;margin:20px 0 10px;color:#c8b4ff">$1</h1>')
        .replace(/^[-*] (.+)$/gm,'<div style="padding-left:16px;margin:3px 0">\u2022 $1</div>')
        .replace(/\n{2,}/g,'<div style="height:12px"></div>')
        .replace(/\n/g,"<br/>");
    }

    // ── System prompt ──
    const SYSTEM_PROMPT = `You are IdeaPilot — a sharp, strategic AI assistant built for a physician-entrepreneur who is deeply interested in AI and healthcare innovation.

Your role:
1. When the user shares an IDEA, research it thoroughly:
   - Assess novelty, market fit, feasibility
   - Identify competitors and prior art
   - Rate it on a 1-10 scale for viability
   - If rated 7+, provide a detailed action plan (market size, MVP steps, tech stack, regulatory considerations if healthcare-related)
   - If rated below 7, explain why and suggest pivots

2. When analyzing PDFs or images, extract key insights and relate them to the user's goals.

3. When asked general questions, answer with depth and precision appropriate for a physician with strong technical background.

4. For healthcare AI ideas specifically, consider: FDA/regulatory pathway, HIPAA compliance, clinical validation needs, reimbursement strategy, and integration with existing EHR workflows.

Keep responses focused and actionable. Use clear structure. Be direct — no fluff.`;

    // ── Modal ──
    function Modal(props) {
      return h('div', {
        style:{position:"fixed",inset:0,background:"rgba(0,0,0,0.7)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:200,backdropFilter:"blur(6px)"},
        onClick: props.onClose
      },
        h('div', {
          onClick: (e) => e.stopPropagation(),
          style:{background:"linear-gradient(135deg,#151520,#12121e)",borderRadius:16,padding:24,width:"90%",maxWidth:420,border:"1px solid rgba(139,92,246,0.2)",boxShadow:"0 20px 60px rgba(0,0,0,0.5)"}
        }, props.children)
      );
    }

    // ── Idea Item ──
    function IdeaItem(props) {
      const [hovered, setHovered] = useState(false);
      const { idea, active, onOpen, onStar, onDelete, onShare } = props;
      return h('div', {
        onClick: () => onOpen(idea.id),
        onMouseEnter: () => setHovered(true),
        onMouseLeave: () => setHovered(false),
        onTouchStart: () => setHovered(true),
        onTouchEnd: () => setTimeout(() => setHovered(false), 1000),
        style:{padding:"10px 12px",borderRadius:10,marginBottom:2,cursor:"pointer",transition:"all 0.15s",background:active?"rgba(139,92,246,0.12)":hovered?"rgba(139,92,246,0.06)":"transparent",border:active?"1px solid rgba(139,92,246,0.2)":"1px solid transparent",display:"flex",alignItems:"center",gap:10}
      },
        h('div', {style:{flex:1,minWidth:0}},
          h('div', {style:{fontSize:13,fontWeight:600,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",color:active?"#c8b4ff":"#b0aac0"}}, idea.title),
          h('div', {style:{fontSize:10,color:"#4a4660",marginTop:2}}, new Date(idea.createdAt).toLocaleDateString() + " \u00B7 " + (idea.messages?.length||0) + " msgs")
        ),
        (hovered || active) ? h('div', {style:{display:"flex",gap:2,flexShrink:0},onClick:e=>e.stopPropagation()},
          h('button', {onClick:()=>onStar(idea.id),style:{background:"none",border:"none",color:idea.starred?"#f59e0b":"#4a4660",cursor:"pointer",padding:3}}, h(Icons.Star, {size:13,fill:idea.starred?"#f59e0b":"none"})),
          h('button', {onClick:()=>onShare(idea.id),style:{background:"none",border:"none",color:"#4a4660",cursor:"pointer",padding:3}}, h(Icons.Share, {size:13})),
          h('button', {onClick:()=>onDelete(idea.id),style:{background:"none",border:"none",color:"#4a4660",cursor:"pointer",padding:3}}, h(Icons.Trash, {size:13}))
        ) : null
      );
    }

    // ── Main App ──
    function IdeaPilot() {
      const [ideas, setIdeas] = useState([]);
      const [activeIdea, setActiveIdea] = useState(null);
      const [input, setInput] = useState("");
      const [messages, setMessages] = useState([]);
      const [loading, setLoading] = useState(false);
      const [sidebarOpen, setSidebarOpen] = useState(window.innerWidth > 768);
      const [isRecording, setIsRecording] = useState(false);
      const [attachedFile, setAttachedFile] = useState(null);
      const [searchQuery, setSearchQuery] = useState("");
      const [shareModal, setShareModal] = useState(null);
      const [shareEmail, setShareEmail] = useState("");
      const [copied, setCopied] = useState(false);
      const [deleteConfirm, setDeleteConfirm] = useState(null);
      const [mobileSidebar, setMobileSidebar] = useState(false);

      const chatEndRef = useRef(null);
      const fileInputRef = useRef(null);
      const mediaRecorderRef = useRef(null);
      const textareaRef = useRef(null);

      useEffect(() => { setIdeas(loadIdeas()); }, []);
      useEffect(() => { saveIdeas(ideas); }, [ideas]);
      useEffect(() => { chatEndRef.current?.scrollIntoView({behavior:"smooth"}); }, [messages, loading]);
      useEffect(() => {
        if (textareaRef.current) {
          textareaRef.current.style.height = "auto";
          textareaRef.current.style.height = Math.min(textareaRef.current.scrollHeight, 150) + "px";
        }
      }, [input]);

      // API call
      const callClaude = async (userMessages) => {
        const apiMessages = userMessages.map(m => {
          if (m.role === "user" && m.fileData) {
            const content = [];
            if (m.fileData.type === "image") content.push({type:"image",source:{type:"base64",media_type:m.fileData.mediaType,data:m.fileData.data}});
            else if (m.fileData.type === "pdf") content.push({type:"document",source:{type:"base64",media_type:"application/pdf",data:m.fileData.data}});
            content.push({type:"text",text:m.content});
            return {role:"user",content};
          }
          return {role:m.role,content:m.content};
        });
        const response = await fetch("/api/chat", {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({model:ANTHROPIC_MODEL,max_tokens:4096,system:SYSTEM_PROMPT,tools:[{type:"web_search_20250305",name:"web_search"}],messages:apiMessages})
        });
        const data = await response.json();
        if (data.error) throw new Error(data.error.message || "API error");
        return (data.content?.filter(b=>b.type==="text").map(b=>b.text)||[]).join("\n\n") || "I couldn't generate a response.";
      };

      // Send message
      const sendMessage = async (text, file) => {
        text = text !== undefined ? text : input;
        file = file !== undefined ? file : attachedFile;
        const trimmed = (text||"").trim();
        if (!trimmed && !file) return;

        let fileData = null;
        if (file) {
          const base64 = await new Promise((res, rej) => { const r = new FileReader(); r.onload = () => res(r.result.split(",")[1]); r.onerror = () => rej(new Error("Read failed")); r.readAsDataURL(file); });
          fileData = { type: file.type.startsWith("image/") ? "image" : "pdf", mediaType: file.type, data: base64, name: file.name };
        }

        const userMsg = { role:"user", content: trimmed || "Analyze this " + (fileData?.type==="image"?"image":"document") + ": " + fileData?.name, fileData, timestamp: Date.now() };
        const newMessages = [...messages, userMsg];
        setMessages(newMessages);
        setInput("");
        setAttachedFile(null);
        setLoading(true);

        try {
          const reply = await callClaude(newMessages);
          const updated = [...newMessages, {role:"assistant",content:reply,timestamp:Date.now()}];
          setMessages(updated);
          if (!activeIdea && newMessages.length <= 2) {
            const title = trimmed.length > 60 ? trimmed.slice(0,57)+"..." : trimmed;
            const newI = {id:Date.now().toString(),title,messages:updated,createdAt:Date.now(),starred:false};
            setIdeas(prev => [newI,...prev]);
            setActiveIdea(newI.id);
          } else if (activeIdea) {
            setIdeas(prev => prev.map(i => i.id===activeIdea ? {...i,messages:updated} : i));
          }
        } catch (err) {
          setMessages(prev => [...prev, {role:"assistant",content:"Error: "+err.message+". Please check your connection.",timestamp:Date.now()}]);
        } finally { setLoading(false); }
      };

      // Voice
      const toggleRecording = async () => {
        if (isRecording) { mediaRecorderRef.current?.stop(); setIsRecording(false); return; }
        try {
          const stream = await navigator.mediaDevices.getUserMedia({audio:true});
          const recorder = new MediaRecorder(stream);
          recorder.onstop = () => stream.getTracks().forEach(t=>t.stop());
          mediaRecorderRef.current = recorder;
          const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
          if (SR) {
            const recog = new SR();
            recog.continuous = false; recog.interimResults = false; recog.lang = "en-US";
            recog.onresult = (e) => { const t = e.results[0][0].transcript; setInput(prev => prev ? prev+" "+t : t); };
            recog.onerror = () => setIsRecording(false);
            recog.onend = () => setIsRecording(false);
            recog.start();
          }
          recorder.start();
          setIsRecording(true);
        } catch { alert("Microphone access denied."); }
      };

      // File
      const handleFileUpload = (e) => {
        const file = e.target.files[0]; if (!file) return;
        if (!["application/pdf","image/png","image/jpeg","image/webp","image/gif"].includes(file.type)) { alert("Please upload a PDF or image."); return; }
        setAttachedFile(file);
      };

      // Idea mgmt
      const newIdea = () => { setActiveIdea(null); setMessages([]); setInput(""); setAttachedFile(null); setMobileSidebar(false); };
      const openIdea = (id) => { const idea = ideas.find(i=>i.id===id); if(idea){setActiveIdea(id);setMessages(idea.messages||[]);setMobileSidebar(false);} };
      const deleteIdea = (id) => { setIdeas(prev=>prev.filter(i=>i.id!==id)); if(activeIdea===id){setActiveIdea(null);setMessages([]);} setDeleteConfirm(null); };
      const toggleStar = (id) => { setIdeas(prev=>prev.map(i=>i.id===id?{...i,starred:!i.starred}:i)); };

      // Share
      const getShareContent = (idea) => { if(!idea) return ""; let c = "IdeaPilot \u2014 "+idea.title+"\n"+"\u2500".repeat(40)+"\n\n"; idea.messages?.forEach(m=>{c+=(m.role==="user"?"You":"IdeaPilot")+": "+m.content+"\n\n";}); return c; };
      const handleCopy = (idea) => { navigator.clipboard.writeText(getShareContent(idea)); setCopied(true); setTimeout(()=>setCopied(false),2000); };
      const handleEmail = (idea) => { window.open("mailto:"+encodeURIComponent(shareEmail)+"?subject="+encodeURIComponent("IdeaPilot: "+idea.title)+"&body="+encodeURIComponent(getShareContent(idea))); setShareModal(null); setShareEmail(""); };
      const handleSMS = (idea) => { window.open("sms:?body="+encodeURIComponent(getShareContent(idea))); };

      // Filter
      const filteredIdeas = ideas.filter(i => i.title.toLowerCase().includes(searchQuery.toLowerCase()));
      const starredIdeas = filteredIdeas.filter(i => i.starred);
      const unstarredIdeas = filteredIdeas.filter(i => !i.starred);
      const activeIdeaObj = ideas.find(i => i.id === activeIdea);

      const isMobile = typeof window !== 'undefined' && window.innerWidth < 768;

      return h('div', {style:{display:"flex",height:"100vh",width:"100vw",background:"#0a0a12",overflow:"hidden"}},

        // Mobile overlay
        mobileSidebar ? h('div', {onClick:()=>setMobileSidebar(false), style:{position:"fixed",inset:0,background:"rgba(0,0,0,0.6)",zIndex:99,backdropFilter:"blur(4px)"}}) : null,

        // Sidebar
        h('aside', {className: !mobileSidebar && isMobile ? "sidebar-default" : "", style:{
          width: sidebarOpen||mobileSidebar ? 300 : 0, minWidth: sidebarOpen||mobileSidebar ? 300 : 0,
          background:"linear-gradient(180deg,#0d0d1a,#0a0a14)", borderRight: sidebarOpen||mobileSidebar ? "1px solid rgba(139,92,246,0.15)" : "none",
          display:"flex",flexDirection:"column",transition:"all 0.3s cubic-bezier(0.4,0,0.2,1)",overflow:"hidden",
          position: mobileSidebar ? "fixed" : "relative", zIndex: mobileSidebar ? 100 : 1, height:"100%"
        }},
          // Logo
          h('div', {style:{padding:"20px 20px 16px",borderBottom:"1px solid rgba(139,92,246,0.1)"}},
            h('div', {style:{display:"flex",alignItems:"center",gap:10,marginBottom:16}},
              h('div', {style:{width:38,height:38,display:"flex",alignItems:"center",justifyContent:"center",filter:"drop-shadow(0 0 8px rgba(139,92,246,0.4))"}}, h(NeuralSparkLogo, {size:38})),
              h('div', null,
                h('div', {style:{fontWeight:800,fontSize:18,letterSpacing:"-0.5px",fontFamily:"'Space Mono',monospace"}}, "IdeaPilot"),
                h('div', {style:{fontSize:10,color:"#8b5cf6",fontWeight:600,letterSpacing:"2px",textTransform:"uppercase"}}, "AI Research Lab")
              )
            ),
            h('button', {onClick:newIdea, style:{width:"100%",padding:"10px 14px",borderRadius:10,background:"linear-gradient(135deg,#8b5cf6,#7c3aed)",border:"none",color:"#fff",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",gap:8,fontSize:13,fontWeight:600,boxShadow:"0 4px 15px rgba(139,92,246,0.3)"}},
              h(Icons.Plus, {size:16}), " New Idea"
            )
          ),
          // Search
          h('div', {style:{padding:"12px 16px 8px"}},
            h('div', {style:{display:"flex",alignItems:"center",gap:8,background:"rgba(139,92,246,0.08)",borderRadius:8,padding:"8px 12px",border:"1px solid rgba(139,92,246,0.1)"}},
              h(Icons.Search, {size:14}),
              h('input', {value:searchQuery,onChange:e=>setSearchQuery(e.target.value),placeholder:"Search ideas...",style:{background:"transparent",border:"none",color:"#e8e4f0",outline:"none",width:"100%",fontSize:13,fontFamily:"inherit"}})
            )
          ),
          // Ideas list
          h('div', {style:{flex:1,overflowY:"auto",padding:"8px 12px"}},
            starredIdeas.length > 0 ? h(Fragment, null,
              h('div', {style:{fontSize:10,fontWeight:700,color:"#8b5cf6",letterSpacing:"1.5px",textTransform:"uppercase",padding:"8px 8px 4px",marginTop:4}}, "Starred"),
              ...starredIdeas.map(idea => h(IdeaItem, {key:idea.id,idea,active:activeIdea===idea.id,onOpen:openIdea,onStar:toggleStar,onDelete:id=>setDeleteConfirm(id),onShare:id=>setShareModal(id)}))
            ) : null,
            h('div', {style:{fontSize:10,fontWeight:700,color:"#6b6780",letterSpacing:"1.5px",textTransform:"uppercase",padding:"8px 8px 4px",marginTop:4}}, (starredIdeas.length>0?"All Ideas":"Ideas")+" ("+unstarredIdeas.length+")"),
            unstarredIdeas.length===0 ? h('div', {style:{padding:"20px 8px",textAlign:"center",color:"#4a4660",fontSize:13}}, searchQuery?"No matching ideas":"No ideas yet. Start by sharing one!") : null,
            ...unstarredIdeas.map(idea => h(IdeaItem, {key:idea.id,idea,active:activeIdea===idea.id,onOpen:openIdea,onStar:toggleStar,onDelete:id=>setDeleteConfirm(id),onShare:id=>setShareModal(id)}))
          )
        ),

        // Main
        h('main', {style:{flex:1,display:"flex",flexDirection:"column",minWidth:0}},
          // Header
          h('header', {style:{padding:"12px 20px",borderBottom:"1px solid rgba(139,92,246,0.1)",display:"flex",alignItems:"center",gap:12,background:"rgba(10,10,18,0.8)",backdropFilter:"blur(12px)"}},
            h('button', {onClick:()=>{if(window.innerWidth<768)setMobileSidebar(!mobileSidebar);else setSidebarOpen(!sidebarOpen);},style:{background:"none",border:"none",color:"#8b5cf6",cursor:"pointer",padding:4}}, h(Icons.Menu, {})),
            h('div', {style:{flex:1}},
              h('div', {style:{fontWeight:700,fontSize:15}}, activeIdeaObj ? activeIdeaObj.title : "New Conversation"),
              h('div', {style:{fontSize:11,color:"#6b6780"}}, activeIdeaObj ? "Created "+new Date(activeIdeaObj.createdAt).toLocaleDateString() : "Share an idea to get started")
            ),
            activeIdeaObj ? h('div', {style:{display:"flex",gap:4}},
              h('button', {onClick:()=>toggleStar(activeIdea),style:{background:"none",border:"none",color:activeIdeaObj.starred?"#f59e0b":"#6b6780",cursor:"pointer",padding:6}}, h(Icons.Star, {size:18,fill:activeIdeaObj.starred?"#f59e0b":"none"})),
              h('button', {onClick:()=>setShareModal(activeIdea),style:{background:"none",border:"none",color:"#6b6780",cursor:"pointer",padding:6}}, h(Icons.Share, {})),
              h('button', {onClick:()=>setDeleteConfirm(activeIdea),style:{background:"none",border:"none",color:"#6b6780",cursor:"pointer",padding:6}}, h(Icons.Trash, {}))
            ) : null
          ),

          // Messages
          h('div', {style:{flex:1,overflowY:"auto",padding:"20px",display:"flex",flexDirection:"column",gap:16}},
            // Welcome screen
            messages.length === 0 ? h('div', {style:{flex:1,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:20,padding:40,textAlign:"center"}},
              h('div', {style:{width:80,height:80,display:"flex",alignItems:"center",justifyContent:"center",filter:"drop-shadow(0 0 16px rgba(139,92,246,0.35))"}}, h(NeuralSparkLogo, {size:80})),
              h('div', null,
                h('h2', {style:{fontSize:22,fontWeight:800,margin:"0 0 8px",letterSpacing:"-0.5px"}}, "What's your next big idea?"),
                h('p', {style:{color:"#6b6780",fontSize:14,margin:0,maxWidth:400,lineHeight:1.6}}, "Share an idea, upload a document, or ask a question. I'll research it, assess viability, and help you build an action plan.")
              ),
              h('div', {style:{display:"flex",flexWrap:"wrap",gap:8,justifyContent:"center",marginTop:8}},
                ...["AI-powered triage system for ERs","Remote patient monitoring platform","LLM-based clinical decision support"].map(s =>
                  h('button', {key:s, onClick:()=>setInput(s), style:{padding:"8px 16px",borderRadius:20,background:"rgba(139,92,246,0.08)",border:"1px solid rgba(139,92,246,0.15)",color:"#c8b4ff",cursor:"pointer",fontSize:12.5,fontFamily:"inherit"}}, s, " ", h(Icons.ChevRight, {size:12}))
                )
              )
            ) : null,

            // Chat messages
            ...messages.map((msg,i) =>
              h('div', {key:i, style:{display:"flex",justifyContent:msg.role==="user"?"flex-end":"flex-start",alignItems:"flex-start",gap:8,animation:"fadeIn 0.3s ease"}},
                msg.role==="assistant" ? h('div', {style:{flexShrink:0,marginTop:2}}, h(NeuralSparkLogo, {size:28})) : null,
                h('div', {style:{maxWidth:msg.role==="user"?"75%":"82%",padding:"12px 16px",borderRadius:msg.role==="user"?"16px 16px 4px 16px":"16px 16px 16px 4px",background:msg.role==="user"?"linear-gradient(135deg,#7c3aed,#6d28d9)":"rgba(30,28,45,0.8)",border:msg.role==="user"?"none":"1px solid rgba(139,92,246,0.1)",fontSize:14,lineHeight:1.65}},
                  msg.fileData ? h('div', {style:{display:"inline-flex",alignItems:"center",gap:6,background:"rgba(139,92,246,0.15)",borderRadius:8,padding:"4px 10px",marginBottom:8,fontSize:12}},
                    h(msg.fileData.type==="image" ? Icons.Image : Icons.File, {size:14}), msg.fileData.name
                  ) : null,
                  msg.role==="assistant" ? h('div', {dangerouslySetInnerHTML:{__html:renderMarkdown(msg.content)}}) : h('div', null, msg.content),
                  h('div', {style:{fontSize:10,color:msg.role==="user"?"rgba(255,255,255,0.5)":"#4a4660",marginTop:6}}, new Date(msg.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}))
                )
              )
            ),

            // Loading
            loading ? h('div', {style:{display:"flex",justifyContent:"flex-start",alignItems:"flex-start",gap:8}},
              h('div', {style:{flexShrink:0,marginTop:6}}, h(NeuralSparkLogo, {size:28})),
              h('div', {style:{padding:"14px 20px",borderRadius:"16px 16px 16px 4px",background:"rgba(30,28,45,0.8)",border:"1px solid rgba(139,92,246,0.1)",display:"flex",alignItems:"center",gap:6}},
                h('div', {style:{display:"flex",gap:4}},
                  ...[0,1,2].map(i => h('div', {key:i, style:{width:7,height:7,borderRadius:"50%",background:"#8b5cf6",animation:"pulse 1.4s "+(i*0.2)+"s infinite ease-in-out"}}))
                ),
                h('span', {style:{fontSize:12,color:"#8b5cf6",marginLeft:6}}, "Researching...")
              )
            ) : null,
            h('div', {ref:chatEndRef})
          ),

          // Input
          h('div', {className:"input-area", style:{padding:"12px 20px 20px",borderTop:"1px solid rgba(139,92,246,0.08)",background:"rgba(10,10,18,0.9)",backdropFilter:"blur(12px)"}},
            attachedFile ? h('div', {style:{display:"inline-flex",alignItems:"center",gap:8,background:"rgba(139,92,246,0.1)",borderRadius:8,padding:"6px 12px",marginBottom:8,fontSize:12,border:"1px solid rgba(139,92,246,0.15)"}},
              h(attachedFile.type.startsWith("image/") ? Icons.Image : Icons.File, {size:14}), attachedFile.name,
              h('button', {onClick:()=>setAttachedFile(null),style:{background:"none",border:"none",color:"#f87171",cursor:"pointer",padding:0,display:"flex"}}, h(Icons.X, {size:14}))
            ) : null,
            h('div', {style:{display:"flex",alignItems:"flex-end",gap:8,background:"rgba(30,28,45,0.6)",borderRadius:16,padding:"8px 8px 8px 16px",border:"1px solid rgba(139,92,246,0.12)"}},
              h('button', {onClick:()=>fileInputRef.current?.click(),title:"Upload PDF or image",style:{background:"none",border:"none",color:"#6b6780",cursor:"pointer",padding:6,borderRadius:8,flexShrink:0,marginBottom:2}}, h(Icons.File, {})),
              h('input', {ref:fileInputRef,type:"file",accept:".pdf,image/*",onChange:handleFileUpload,style:{display:"none"}}),
              h('textarea', {ref:textareaRef,value:input,onChange:e=>setInput(e.target.value),onKeyDown:e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();sendMessage();}},placeholder:"Describe your idea, ask a question, or upload a file...",rows:1,style:{flex:1,background:"transparent",border:"none",color:"#e8e4f0",outline:"none",resize:"none",fontSize:14,fontFamily:"inherit",lineHeight:1.5,padding:"6px 0",maxHeight:150}}),
              h('button', {onClick:toggleRecording,title:isRecording?"Stop":"Voice input",style:{background:isRecording?"rgba(239,68,68,0.2)":"none",border:isRecording?"1px solid rgba(239,68,68,0.3)":"none",color:isRecording?"#ef4444":"#6b6780",cursor:"pointer",padding:8,borderRadius:10,flexShrink:0,animation:isRecording?"pulse 1.5s infinite":"none"}}, h(isRecording?Icons.Stop:Icons.Mic, {size:18})),
              h('button', {onClick:()=>sendMessage(),disabled:loading||(!input.trim()&&!attachedFile),style:{background:loading||(!input.trim()&&!attachedFile)?"rgba(139,92,246,0.2)":"linear-gradient(135deg,#8b5cf6,#7c3aed)",border:"none",color:"#fff",cursor:loading?"default":"pointer",padding:10,borderRadius:10,flexShrink:0,opacity:loading||(!input.trim()&&!attachedFile)?0.5:1}}, h(Icons.Send, {size:18}))
            ),
            h('div', {style:{textAlign:"center",marginTop:8,fontSize:10,color:"#3a3650"}}, "Powered by Claude AI")
          )
        ),

        // Delete modal
        deleteConfirm ? h(Modal, {onClose:()=>setDeleteConfirm(null)},
          h('div', {style:{textAlign:"center"}},
            h('div', {style:{width:48,height:48,borderRadius:12,background:"rgba(239,68,68,0.15)",display:"flex",alignItems:"center",justifyContent:"center",margin:"0 auto 16px"}}, h(Icons.Trash, {size:22})),
            h('h3', {style:{margin:"0 0 8px",fontSize:17,fontWeight:700}}, "Delete this idea?"),
            h('p', {style:{color:"#6b6780",fontSize:13,margin:"0 0 20px"}}, "This action cannot be undone."),
            h('div', {style:{display:"flex",gap:10}},
              h('button', {onClick:()=>setDeleteConfirm(null),style:{flex:1,padding:10,borderRadius:10,background:"rgba(139,92,246,0.1)",border:"1px solid rgba(139,92,246,0.15)",color:"#c8b4ff",cursor:"pointer",fontWeight:600,fontSize:13}}, "Cancel"),
              h('button', {onClick:()=>deleteIdea(deleteConfirm),style:{flex:1,padding:10,borderRadius:10,background:"linear-gradient(135deg,#ef4444,#dc2626)",border:"none",color:"#fff",cursor:"pointer",fontWeight:600,fontSize:13}}, "Delete")
            )
          )
        ) : null,

        // Share modal
        shareModal ? h(Modal, {onClose:()=>{setShareModal(null);setShareEmail("");}},
          h('div', null,
            h('h3', {style:{margin:"0 0 4px",fontSize:17,fontWeight:700}}, "Share Idea"),
            h('p', {style:{color:"#6b6780",fontSize:13,margin:"0 0 20px"}}, "Send via email, text, or copy to clipboard."),
            h('div', {style:{marginBottom:12}},
              h('label', {style:{fontSize:12,fontWeight:600,color:"#8b5cf6",marginBottom:6,display:"block"}}, "Email to"),
              h('div', {style:{display:"flex",gap:8}},
                h('input', {value:shareEmail,onChange:e=>setShareEmail(e.target.value),placeholder:"recipient@email.com",type:"email",style:{flex:1,padding:"10px 14px",borderRadius:10,background:"rgba(139,92,246,0.08)",border:"1px solid rgba(139,92,246,0.15)",color:"#e8e4f0",outline:"none",fontFamily:"inherit",fontSize:13}}),
                h('button', {onClick:()=>handleEmail(ideas.find(i=>i.id===shareModal)),disabled:!shareEmail.includes("@"),style:{padding:"10px 16px",borderRadius:10,background:shareEmail.includes("@")?"linear-gradient(135deg,#8b5cf6,#7c3aed)":"rgba(139,92,246,0.2)",border:"none",color:"#fff",cursor:shareEmail.includes("@")?"pointer":"default",fontWeight:600,fontSize:13,display:"flex",alignItems:"center",gap:6,opacity:shareEmail.includes("@")?1:0.5}}, h(Icons.Mail, {size:14}), " Send")
              )
            ),
            h('div', {style:{display:"flex",gap:8}},
              h('button', {onClick:()=>handleSMS(ideas.find(i=>i.id===shareModal)),style:{flex:1,padding:10,borderRadius:10,background:"rgba(6,182,212,0.1)",border:"1px solid rgba(6,182,212,0.2)",color:"#06b6d4",cursor:"pointer",fontWeight:600,fontSize:13,display:"flex",alignItems:"center",justifyContent:"center",gap:6}}, h(Icons.Send, {size:14}), " Text"),
              h('button', {onClick:()=>handleCopy(ideas.find(i=>i.id===shareModal)),style:{flex:1,padding:10,borderRadius:10,background:copied?"rgba(34,197,94,0.15)":"rgba(139,92,246,0.08)",border:"1px solid "+(copied?"rgba(34,197,94,0.3)":"rgba(139,92,246,0.15)"),color:copied?"#22c55e":"#c8b4ff",cursor:"pointer",fontWeight:600,fontSize:13,display:"flex",alignItems:"center",justifyContent:"center",gap:6}}, h(Icons.Copy, {size:14}), copied?" Copied!":" Copy")
            )
          )
        ) : null
      );
    }

    // Mount
    ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(IdeaPilot));
  </script>
</body>
</html>
